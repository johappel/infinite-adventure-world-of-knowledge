<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YAML Player System Test</title>
    <style>
        body {
            margin: 0;
            background: #222;
            font-family: Arial, sans-serif;
            color: white;
        }
        #test-container {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
        }
        button {
            margin: 5px;
            padding: 8px 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
        #status {
            margin-top: 10px;
            padding: 8px;
            background: #333;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="test-container">
        <h3>🧪 YAML Player System Test</h3>
        <button onclick="testPlayerSystem()">Test Player Avatar</button>
        <button onclick="testFallback()">Test Fallback (ohne Player)</button>
        <button onclick="testCustomPlayer()">Test Custom Player</button>
        <div id="status">Bereit zum Testen...</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script type="module">
        import { buildZoneFromSpec } from './js/world-generation/index.js';

        let scene, camera, renderer;
        let currentGroup = null;

        // Initialize Three.js Scene
        function initThreeJS() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x87CEEB);
            document.body.appendChild(renderer.domElement);

            // Basic lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);

            camera.position.set(5, 5, 5);
            camera.lookAt(0, 0, 0);

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            
            // Update player animations if available
            if (currentGroup) {
                currentGroup.traverse((child) => {
                    if (child.userData && child.userData.yamlPlayer) {
                        child.userData.yamlPlayer.update();
                    }
                });
            }
            
            renderer.render(scene, camera);
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // Test Functions
        window.testPlayerSystem = function() {
            updateStatus('Testing Player Avatar System...');
            
            const testYaml = \`
zone_id: "player-test"
terrain:
  type: "flat"
  size: [30, 30]
  color: "#4CAF50"
player:
  appearance:
    body_color: "#ff6b6b"
    skin_color: "#f4c2a1"
    hair_color: "#8b4513"
    height: 1.2
    proportions:
      head_size: 0.45
      torso_height: 1.1
      arm_length: 0.8
      leg_length: 1.0
  style:
    hair_type: "spikes"
    accessories: ["cape"]
  animations:
    idle:
      arm_swing: 0.15
      body_sway: 0.08
    walking:
      arm_swing: 1.0
      leg_swing: 0.9
      speed: 12
environment:
  lighting:
    ambient: "#404040"
    directional: "#ffffff"
\`;

            try {
                const worldData = jsyaml.load(testYaml);
                if (currentGroup) {
                    scene.remove(currentGroup);
                }
                
                const result = buildZoneFromSpec(worldData);
                currentGroup = result.group;
                scene.add(currentGroup);
                
                if (result.player) {
                    updateStatus('✅ Player Avatar geladen! Roter Avatar mit Spikes und Cape sollte sichtbar sein.');
                    camera.position.set(3, 2, 3);
                    camera.lookAt(0, 0.5, 0);
                } else {
                    updateStatus('❌ Kein Player Avatar gefunden. Check die Konsole für Fehler.');
                }
            } catch (error) {
                updateStatus('❌ Fehler: ' + error.message);
                console.error('Test Error:', error);
            }
        };

        window.testFallback = function() {
            updateStatus('Testing Fallback (kein Player config)...');
            
            const testYaml = \`
zone_id: "fallback-test"
terrain:
  type: "flat"
  size: [30, 30]
  color: "#4CAF50"
environment:
  lighting:
    ambient: "#404040"
    directional: "#ffffff"
\`;

            try {
                const worldData = jsyaml.load(testYaml);
                if (currentGroup) {
                    scene.remove(currentGroup);
                }
                
                const result = buildZoneFromSpec(worldData);
                currentGroup = result.group;
                scene.add(currentGroup);
                
                updateStatus('✅ Fallback Test: Keine Player Config = Kein Avatar (erwartetes Verhalten)');
                camera.position.set(3, 2, 3);
                camera.lookAt(0, 0, 0);
            } catch (error) {
                updateStatus('❌ Fehler: ' + error.message);
                console.error('Fallback Test Error:', error);
            }
        };

        window.testCustomPlayer = function() {
            updateStatus('Testing Custom Player...');
            
            const testYaml = \`
zone_id: "custom-player-test"
terrain:
  type: "flat"
  size: [30, 30]
  color: "#8b4513"
player:
  appearance:
    body_color: "#00ff00"
    skin_color: "#90ee90"
    hair_color: "#ffffff"
    height: 0.8
    proportions:
      head_size: 0.5
      torso_height: 0.9
  style:
    hair_type: "long"
    accessories: ["cape", "glasses"]
  animations:
    idle:
      arm_swing: 0.3
      body_sway: 0.15
    walking:
      arm_swing: 1.5
      leg_swing: 1.3
      speed: 15
environment:
  lighting:
    ambient: "#404040"
    directional: "#ffffff"
\`;

            try {
                const worldData = jsyaml.load(testYaml);
                if (currentGroup) {
                    scene.remove(currentGroup);
                }
                
                const result = buildZoneFromSpec(worldData);
                currentGroup = result.group;
                scene.add(currentGroup);
                
                if (result.player) {
                    updateStatus('✅ Custom Player geladen! Grüner Avatar mit langem Haar, Cape und Brille.');
                    camera.position.set(3, 2, 3);
                    camera.lookAt(0, 0.5, 0);
                } else {
                    updateStatus('❌ Custom Player nicht geladen. Check Konsole.');
                }
            } catch (error) {
                updateStatus('❌ Fehler: ' + error.message);
                console.error('Custom Player Test Error:', error);
            }
        };

        // Initialize when page loads
        window.addEventListener('load', () => {
            initThreeJS();
            updateStatus('Three.js initialized. Bereit zum Testen!');
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
