<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>World Editor</title>

  <!-- Importmap (Three.js und lokale Module) -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.165.0/examples/jsm/",
      "js-yaml": "https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js",
      "patchkit": "./libs/patchkit/index.js",
      "preset-editor/core": "./editor/js/preset-editor/core.js",
      "preset-editor/yaml-processor": "./editor/js/preset-editor/yaml-processor.js",
      "preset-editor/world-manager": "./editor/js/preset-editor/world-manager.js",
      "preset-editor/patch-manager": "./editor/js/preset-editor/patch-manager.js",
      "preset-editor/preview-renderer": "./editor/js/preset-editor/preview-renderer.js",
      "preset-editor/ui-manager": "./editor/js/preset-editor/ui-manager.js",
      "preset-editor": "./editor/js/preset-editor/index.js",
      "three-js-manager": "./editor/js/three-js-manager.js",
      "patch-visualizer": "./editor/js/patch-visualizer.js",
      "patch-ui": "./editor/js/patch-ui.js",
      "toast": "./editor/js/toast.js",
      "patchkit-wiring": "./editor/js/patchkit-wiring.js",
      "load": "./editor/js/load.js"
    }
  }
  </script>

  <!-- Vendor: Ajv + js-yaml + DOMPurify -->
  <!-- Hinweis: ajv2020.min.js ist nicht in allen Versionen vorhanden.
       Wir laden das UMD-Bundle ajv.min.js und aliasen es zu window.ajv2020. -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/8.12.0/ajv2020.bundle.min.js"></script>
  <script>
    (function ensureAjv2020Global(){
      // Falls das UMD-Bundle Ajv global setzt, mappe auf ajv2020
      if (typeof window.ajv2020 === 'undefined' && typeof window.Ajv !== 'undefined') {
        window.ajv2020 = window.Ajv;
      }
      console.log('Ajv availability:', { Ajv: typeof window.Ajv, ajv2020: typeof window.ajv2020 });
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <!-- DOMPurify für robustes HTML-Escaping -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.11/purify.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- NostrServiceFactory vor dem Bootstrap global setzen -->
  <script type="module">
    import * as NS from './js/core/net/nostr-service-factory.js';
    const factory = (NS && 'default' in NS) ? NS.default : NS;
    window.NostrServiceFactory = factory;
    console.log('NostrServiceFactory gesetzt?', !!window.NostrServiceFactory);
    console.log('Ajv (ajv2020) global?', typeof window.ajv2020);
    console.log('DOMPurify global?', typeof window.DOMPurify);
  </script>

  <!-- Editor CSS -->
  <link rel="stylesheet" href="./editor/css/editor.css" />
</head>
<body>
  <!-- Toast Root -->
  <div id="toast-root" class="toast-container" aria-live="polite" aria-atomic="true"></div>

  <div class="header">
    <h1>🎯 World Editor</h1>
    <div class="controls">
      <!-- Haupt-Aktionsgruppe -->
      <div class="control-group main-actions">
        <button class="btn" id="newWorldBtn" title="Neue leere Welt mit eindeutiger ID erstellen">➕ Neu</button>
        <select class="preset-selector" id="presetSelect" aria-label="Preset Template auswählen">
          <option value="">Neu von Vorlage</option>
          <optgroup label="Lokale Vorlagen" id="localPresetsGroup">
            <!-- Wird dynamisch befüllt -->
          </optgroup>
          <optgroup label="Worlds aus /worlds" id="worldFilesGroup">
            <option value="" disabled>(wird geladen …)</option>
          </optgroup>
        </select>
        <!-- <button class="btn" id="loadWorldBtn" title="Welt anhand der ID laden">🌐 Laden</button> -->
        <button class="btn success" id="saveGenesisBtn" title="Aktuelle Welt als Genesis speichern">💾 Speichern</button>
        <button class="btn success" id="savePatchBtn" title="Als Patch speichern" style="display: none;">🧩 Patch speichern</button>
      </div>
      
      <!-- Sekundäre-Aktionsgruppe (wird in Sidebar verschoben) -->
      <div class="control-group secondary-actions" style="display: none;">
      </div>
      
      <!-- Vorschau-Aktionsgruppe (vereinfacht) -->
      <div class="control-group preview-actions">
        
      </div>
    </div>
  </div>

  <main class="editor-main-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="panel-header">🔍 Suche</div>
      <div class="sidebar-content">
        <input class="preset-selector search-input" id="worldSearchInput" placeholder="Gespeicherte Welten..." title="Suche in gespeicherten Welten">
        <div id="worldSearchResults" class="search-results" style="display:none;"></div>
      </div>
      <div id="patch-list-container" class="patch-list-panel">
          <!-- Patch list will be rendered here -->
          <div class="panel-header">🧩 Patches</div>
          <div class="patch-list-content"></div>
      </div>
    </aside>

    <!-- YAML Editor Panel -->
    <div class="yaml-editor-panel">
      <div class="panel-header-flex">
        <div class="panel-header-title">📝 YAML Editor</div>
        <input class="preset-selector" id="worldIdInput" placeholder="Keine Welt geladen" title="Welt-ID (NIP-33 d=worldId)" readonly>
      </div>
      
      <!-- Tab-Navigation -->
      <div class="tab-navigation">
        <button id="world-tab" class="tab-button active" data-tab="world" title="Welt-Editor für die Grundkonfiguration">
          <span class="tab-icon">🌍</span>
          <span class="tab-text">Welt</span>
          <span class="tab-name" id="worldName">Unbenannt</span>
        </button>
        <button id="patch-tab" class="tab-button" data-tab="patch" title="Patch-Editor für Änderungen und Erweiterungen">
          <span class="tab-icon">🧩</span>
          <span class="tab-text">Patch</span>
          <span class="tab-name" id="patchName">Neuer Patch</span>
        </button>
      </div>
      
      <!-- Tab-Inhalte -->
      <div class="tab-content active" id="world-editor">
        <textarea class="yaml-editor" id="world-yaml-editor" placeholder="# Deine YAML-Welt hier eingeben...
name: 'Test World'
description: 'Eine Test-Welt für Presets'
"></textarea>
      </div>
      <div class="tab-content" id="patch-editor">
        <div class="patch-editor-container">
          <textarea class="yaml-editor" id="patch-yaml-editor" placeholder="# Wähle einen Patch aus oder erstelle einen neuen..."></textarea>
        </div>
      </div>
    </div>

    <!-- 3D Preview Panel -->
    <div class="preview-panel">
      <div class="panel-header">🎮 3D Vorschau<div id="preview-controls"></div></div>
      <div class="canvas-container">
        <canvas id="preview-canvas"></canvas>
        <div class="loading" id="loadingIndicator">
          <div>🌍 Welt wird geladen...</div>
          <div class="subtext">THREE.js wird initialisiert</div>
        </div>
      </div>
      <div class="status-bar">
        <span id="status-bar">Bereit zum Rendern</span>
        <span id="objectCount">0 Objekte</span>
      </div>
      
      <!-- Patch-Visualisierungskontrollen -->
      <div class="patch-visualization-controls" id="patchVisualizationControls" style="display: none;">
        <div class="controls-header">
          <h3>🎨 Patch-Visualisierung</h3>
          <button id="togglePatchVisualization" class="btn small" title="Visualisierung ein- oder ausschalten">👁️ Ein/Aus</button>
        </div>
        
        <div class="visualization-options">
          <div class="option-row">
            <div class="option-group">
              <label for="visualizationMode">Anzeigemodus:</label>
              <select id="visualizationMode" title="Legt fest, welche Änderungen angezeigt werden">
                <option value="all">Alle Änderungen</option>
                <option value="added">Nur Hinzufügungen</option>
                <option value="modified">Nur Änderungen</option>
                <option value="removed">Nur Entfernungen</option>
                <option value="conflicts">Nur Konflikte</option>
              </select>
            </div>
            
            <div class="option-group">
              <label for="animationMode">Animation:</label>
              <select id="animationMode" title="Legt den Animationsstil fest">
                <option value="none">Keine Animation</option>
                <option value="step">Schrittweise</option>
                <option value="continuous">Fließend</option>
              </select>
            </div>
          </div>
          
          <div class="option-row">
            <div class="option-group">
              <label for="animationSpeed">Geschwindigkeit:</label>
              <div class="slider-container">
                <input type="range" id="animationSpeed" min="0.5" max="5" step="0.5" value="1" title="Animationsgeschwindigkeit einstellen">
                <span id="speedValue">1x</span>
              </div>
            </div>
            
            <div class="option-group">
              <label for="transparency">Transparenz:</label>
              <div class="slider-container">
                <input type="range" id="transparency" min="0.1" max="1" step="0.1" value="0.7" title="Transparenz der Visualisierung einstellen">
                <span id="transparencyValue">70%</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="legend">
          <h4>Legende:</h4>
          <div class="legend-grid">
            <div class="legend-item">
              <span class="legend-color added"></span>
              <span>Hinzugefügt</span>
            </div>
            <div class="legend-item">
              <span class="legend-color modified"></span>
              <span>Geändert</span>
            </div>
            <div class="legend-item">
              <span class="legend-color removed"></span>
              <span>Entfernt</span>
            </div>
            <div class="legend-item">
              <span class="legend-color conflict"></span>
              <span>Konflikt</span>
            </div>
          </div>
        </div>
        
        <div class="action-buttons">
          <button id="startAnimation" class="btn small" title="Startet die Animation der Änderungen">▶️ Animieren</button>
          <button id="resetVisualization" class="btn small" title="Setzt die Visualisierung zurück">🔄 Zurücksetzen</button>
          <button id="focusOnChanges" class="btn small" title="Fokussiert die Kamera auf die Änderungen">🔍 Fokussieren</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Das alte PatchUIContainer wurde entfernt, um die Benutzeroberfläche zu vereinfachen. -->
  <!-- Die Patch-Verwaltung befindet sich jetzt im "Patch"-Tab des YAML-Editors. -->

  <!-- App Scripts (modularisiert) -->
  <script type="module" src="./editor/js/toast.js"></script>
  <script type="module" src="./editor/js/patchkit-wiring.js"></script>
  <script type="module" src="./editor/js/load.js"></script>
  <script type="module">
    import { bootstrapPresetEditor } from './editor/js/preset-editor/index.js';
    import { bootstrapPatchUI } from './editor/js/patch-ui.js';
    import { initLoadFunctionality } from './editor/js/load.js';

    (async () => {
      try {
        // Starte Editor-Bootstrap; dieser nutzt intern patchkit-wiring
        const editor = await bootstrapPresetEditor();

        // UI initialisieren
        const ui = bootstrapPatchUI(editor.patchKit, editor.worldId || null);

        // Load-Funktionalität initialisieren (Suche und Preset-Auswahl)
        try {
          const nostrService = editor.nostrService || await window.NostrServiceFactory.getNostrService();
          console.log('NostrService für Load-Funktionalität:', nostrService);
          console.log('[DEBUG PATCH UI] -------------------------> initLoadFunctionality');
          await initLoadFunctionality(editor, nostrService);
        } catch (e) {
          console.error('Fehler beim Initialisieren der Load-Funktionalität:', e);
          if (window.showToast) window.showToast('error', 'Load-Funktionalität konnte nicht initialisiert werden: ' + e.message);
        }

        // Button-Event-Listener werden jetzt in den jeweiligen Modulen gehandhabt
        // - Neu/Laden/Speichern-Buttons: preset-editor/index.js
        // - Preset-Auswahl: load.js

        // Identitäts-Hinweis (npub) anzeigen
        try {
          const svcMaybe = window.NostrServiceFactory?.getNostrService?.();
          const svc = (svcMaybe && typeof svcMaybe.then === 'function') ? await svcMaybe : svcMaybe;
          const ident = svc && typeof svc.getIdentity === 'function' ? await svc.getIdentity() : null;
          if (ident?.pubkey && window.showToast) {
            window.showToast('info', 'Angemeldet als npub: ' + ident.pubkey);
          }
        } catch {}

        console.log('Bootstrap erfolgreich abgeschlossen.');
      } catch (e) {
        console.error('Bootstrap-Fehler:', e);
        if (window.showToast) window.showToast('error', 'Bootstrap fehlgeschlagen: ' + e.message);
      }
    })();
  </script>
</div>
</html>