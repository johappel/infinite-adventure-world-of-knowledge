<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>World Editor</title>

  <!-- Importmap (Three.js) -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.165.0/examples/jsm/"
    }
  }
  </script>

  <!-- Vendor: Ajv + js-yaml + DOMPurify -->
  <!-- Hinweis: ajv2020.min.js ist nicht in allen Versionen vorhanden.
       Wir laden das UMD-Bundle ajv.min.js und aliasen es zu window.ajv2020. -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/8.12.0/ajv2020.bundle.min.js"></script>
  <script>
    (function ensureAjv2020Global(){
      // Falls das UMD-Bundle Ajv global setzt, mappe auf ajv2020
      if (typeof window.ajv2020 === 'undefined' && typeof window.Ajv !== 'undefined') {
        window.ajv2020 = window.Ajv;
      }
      console.log('Ajv availability:', { Ajv: typeof window.Ajv, ajv2020: typeof window.ajv2020 });
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <!-- DOMPurify f√ºr robustes HTML-Escaping -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.11/purify.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- NostrServiceFactory vor dem Bootstrap global setzen -->
  <script type="module">
    import * as NS from './js/core/net/nostr-service-factory.js';
    const factory = (NS && 'default' in NS) ? NS.default : NS;
    window.NostrServiceFactory = factory;
    console.log('NostrServiceFactory gesetzt?', !!window.NostrServiceFactory);
    console.log('Ajv (ajv2020) global?', typeof window.ajv2020);
    console.log('DOMPurify global?', typeof window.DOMPurify);
  </script>

  <!-- Editor CSS -->
  <link rel="stylesheet" href="./editor/css/editor.css" />
</head>
<body>
  <!-- Toast Root -->
  <div id="toast-root" class="toast-container" aria-live="polite" aria-atomic="true"></div>

  <div class="header">
    <h1>üéØ World Editor</h1>
    <div class="controls">
      <input class="preset-selector" id="worldSearchInput" placeholder="üîé gespeicherte Welt suchen (ID, Name, npub‚Ä¶)" title="Suche in lokal gespeicherten Welt-Genesis (Dexie)">
      <div id="worldSearchResults" class="search-results" style="display:none;"></div>
      <!-- Hinweis: Preset/World-Dropdown wird clientseitig gef√ºllt; IDs m√ºssen mit JS √ºbereinstimmen -->

      <select class="preset-selector" id="presetSelect" aria-label="Preset Template ausw√§hlen">
        <option value="">W√§hle Preset Template...</option>
        <optgroup label="Lokale Presets (eingebaut)" id="localPresetsGroup">
          <!-- Wird dynamisch bef√ºllt -->
        </optgroup>
        <optgroup label="Worlds aus /worlds (*.yaml)" id="worldFilesGroup">
          <option value="" disabled>(wird geladen ‚Ä¶)</option>
        </optgroup>
      </select>

      <input class="preset-selector" id="worldIdInput" placeholder="worldId (z.B. demo-world)" title="Welt-ID (NIP-33 d=worldId)">
      <button class="btn" id="newWorldBtn" title="Neue leere Welt mit eindeutiger WORLD_ID">‚ûï Neu</button>
      <button class="btn" id="loadWorldBtn" title="Genesis 30311 laden">üåê Laden</button>
      <button class="btn success" id="saveGenesisBtn" title="Als Genesis 30311 speichern">üíæ Speichern (Genesis)</button>
      <button class="btn" id="savePatchBtn" title="Als Patch 30312 speichern">üß© Speichern (Patch)</button>

      <button class="btn success" id="renderBtn">üé¨ Rendern</button>
      <button class="btn" id="resetBtn">üîÑ Reset</button>
    </div>
  </div>

  <div class="container">
    <div class="left-panel">
      <div class="panel-header">üìù YAML Editor</div>
      <textarea class="yaml-editor" id="yaml-editor" placeholder="# Deine YAML-Welt hier eingeben...
name: 'Test World'
description: 'Eine Test-Welt f√ºr Presets'
"></textarea>
    </div>

    <div class="right-panel">
      <div class="panel-header">üéÆ 3D Vorschau</div>
      <div class="canvas-container">
        <canvas id="preview-canvas"></canvas>
        <div class="loading" id="loadingIndicator">
          <div>üåç Welt wird geladen...</div>
          <div class="subtext">THREE.js wird initialisiert</div>
        </div>
      </div>
      <div class="status-bar">
        <span id="status-bar">Bereit zum Rendern</span>
        <span id="objectCount">0 Objekte</span>
      </div>
    </div>
  </div>

  <!-- Patch UI v1 -->
  <section id="patchUIContainer" aria-label="Patch-Verwaltung">
    <aside id="patchListPanel" aria-label="Patches">
      <header>
        <strong>Patches</strong>
        <input id="patchFilter" type="search" placeholder="Filter..." aria-label="Patch-Filter" />
      </header>

      <div id="applyUntilContainer">
        <label for="preview-range" style="white-space:nowrap;">Preview bis:</label>
        <input id="preview-range" type="range" min="0" max="0" value="0" step="1" />
        <span id="applyUntilValue">0</span>
      </div>

      <div class="list" id="patch-list" role="listbox" aria-label="Patch-Liste"></div>
    </aside>

    <section>
      <div id="patch-detail" aria-live="polite">
        <div class="pd-title" id="pd-title">(keine Auswahl)</div>
        <div class="pd-row" id="pd-id"></div>
        <div class="pd-row" id="pd-author"></div>
        <div class="pd-row" id="pd-date"></div>
        <div class="pd-row" id="pd-deps"></div>
        <label class="include-toggle"><input type="checkbox" id="pd-include" /> in Preview einbeziehen</label>
        <div class="pd-warn" id="pd-cycle" style="display:none;"></div>
      </div>

      <section id="conflictsPanel" aria-live="polite">
        <h3>Konflikte</h3>
        <div id="conflicts-panel"></div>
      </section>
    </section>
  </section>

  <!-- App Scripts (modularisiert) -->
  <script type="module" src="./editor/js/toast.js"></script>
  <script type="module" src="./editor/js/patchkit-wiring.js"></script>
  <script type="module" src="./editor/js/load.js"></script>
  <script type="module">
    import { bootstrapPresetEditor } from './editor/js/preset-editor.js';
    import { bootstrapPatchUI } from './editor/js/patch-ui.js';
    import { initLoadFunctionality } from './editor/js/load.js';

    (async () => {
      try {
        // Starte Editor-Bootstrap; dieser nutzt intern patchkit-wiring
        const editor = await bootstrapPresetEditor();

        // UI initialisieren
        const ui = bootstrapPatchUI(editor.patchKit, editor.worldId || null);

        // Load-Funktionalit√§t initialisieren (Suche und Preset-Auswahl)
        try {
          const nostrService = editor.nostrService || await window.NostrServiceFactory.getNostrService();
          await initLoadFunctionality(editor, nostrService);
        } catch (e) {
          console.error('Fehler beim Initialisieren der Load-Funktionalit√§t:', e);
          if (window.showToast) window.showToast('error', 'Load-Funktionalit√§t konnte nicht initialisiert werden: ' + e.message);
        }

        // Button-Event-Listener werden jetzt in den jeweiligen Modulen gehandhabt
        // - Neu/Laden/Speichern-Buttons: preset-editor.js
        // - Preset-Auswahl: load.js

        // Identit√§ts-Hinweis (npub) anzeigen
        try {
          const svcMaybe = window.NostrServiceFactory?.getNostrService?.();
          const svc = (svcMaybe && typeof svcMaybe.then === 'function') ? await svcMaybe : svcMaybe;
          const ident = svc && typeof svc.getIdentity === 'function' ? await svc.getIdentity() : null;
          if (ident?.pubkey && window.showToast) {
            window.showToast('info', 'Angemeldet als npub: ' + ident.pubkey);
          }
        } catch {}

        console.log('Bootstrap erfolgreich abgeschlossen.');
      } catch (e) {
        console.error('Bootstrap-Fehler:', e);
        if (window.showToast) window.showToast('error', 'Bootstrap fehlgeschlagen: ' + e.message);
      }
    })();
  </script>
</body>
</html>