<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YAML Preset Editor - Split View</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background: #2d2d30;
            padding: 10px 20px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #4fc3f7;
            font-size: 18px;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            background: #0e639c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn:hover {
            background: #1177bb;
        }

        .btn.success {
            background: #16825d;
        }

        .btn.success:hover {
            background: #1e9870;
        }

        .preset-selector {
            background: #3c3c3c;
            border: 1px solid #5a5a5a;
            color: #d4d4d4;
            padding: 6px 12px;
            border-radius: 4px;
        }

        .container {
            display: flex;
            height: calc(100vh - 60px);
        }

        .left-panel {
            width: 50%;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #3e3e42;
        }

        .right-panel {
            width: 50%;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            background: #252526;
            padding: 10px 15px;
            border-bottom: 1px solid #3e3e42;
            font-weight: bold;
            color: #cccccc;
        }

        .yaml-editor {
            flex: 1;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            border: none;
            outline: none;
            padding: 15px;
            resize: none;
            line-height: 1.5;
        }

        .canvas-container {
            flex: 1;
            background: #000;
            position: relative;
        }

        #renderCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #4fc3f7;
            text-align: center;
        }

        .error {
            background: #f44336;
            color: white;
            padding: 10px 15px;
            margin: 10px;
            border-radius: 4px;
            font-size: 12px;
        }

        .info {
            background: #2196f3;
            color: white;
            padding: 8px 15px;
            margin: 10px;
            border-radius: 4px;
            font-size: 12px;
        }

        .status-bar {
            background: #007acc;
            color: white;
            padding: 5px 15px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
        }

        .subtext { font-size: 12px; margin-top: 10px; color: #4fc3f7; }

        /* YAML Syntax Highlighting */
        .yaml-editor {
            white-space: pre;
            tab-size: 2;
        }
    </style>
    
    <!-- Import Map wie in index.html -->
    <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.165.0/examples/jsm/"
      }
    }
    </script>

    <!-- YAML Parser -->
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
</head>
<body>
    <div class="header">
        <h1>üéØ YAML Preset Editor</h1>
        <div class="controls">
            <select class="preset-selector" id="presetSelect" aria-label="Preset Template ausw√§hlen">
                <option value="">W√§hle Preset Template...</option>
                <option value="simple_world">Einfache Welt</option>
                <option value="forest">Wald-Zone</option>
                <option value="library">Bibliothek</option>
                <option value="single_terrain">Nur Terrain</option>
                <option value="single_object">Nur Objekt</option>
                <option value="single_persona">Nur NPC</option>
            </select>
            <button class="btn" id="loadBtn">üì• Laden</button>
            <button class="btn success" id="renderBtn">üé¨ Rendern</button>
            <button class="btn" id="resetBtn">üîÑ Reset</button>
        </div>
    </div>

    <div class="container">
        <div class="left-panel">
            <div class="panel-header">
                üìù YAML Editor
            </div>
            <textarea class="yaml-editor" id="yamlEditor" placeholder="# Deine YAML-Welt hier eingeben...
name: 'Test World'
description: 'Eine Test-Welt f√ºr Presets'

terrain:
  preset: 'forest_floor'

objects:
  - preset: 'tree_simple'
    position: [0, 0, 0]

personas:
  - preset: 'npc_plain'
    name: 'Test NPC'
    position: [3, 0, 3]"></textarea>
        </div>

        <div class="right-panel">
            <div class="panel-header">
                üéÆ 3D Vorschau
            </div>
            <div class="canvas-container">
                <canvas id="renderCanvas"></canvas>
                <div class="loading" id="loadingIndicator">
                    <div>üåç Welt wird geladen...</div>
                    <div class="subtext">THREE.js wird initialisiert</div>
                </div>
            </div>
            <div class="status-bar">
                <span id="statusText">Bereit zum Rendern</span>
                <span id="objectCount">0 Objekte</span>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import * as THREE from 'three';
        import { buildZoneFromSpec } from './js/world-generation/index.js';
        import { resolveWorldSpec } from './js/world-generation/resolve.js';
        
        class PresetEditor {
            constructor() {
                this.scene = null; this.camera=null; this.renderer=null; this.currentZone=null; this.animationId=null;
                this.initializeElements(); this.initializePresetTemplates(); this.setupEventListeners(); this.initThreeJS();
            }

            initializeElements() {
                this.yamlEditor = document.getElementById('yamlEditor');
                this.canvas = document.getElementById('renderCanvas');
                this.loadingIndicator = document.getElementById('loadingIndicator');
                this.statusText = document.getElementById('statusText');
                this.objectCount = document.getElementById('objectCount');
                this.presetSelect = document.getElementById('presetSelect');
                this.loadBtn = document.getElementById('loadBtn');
                this.renderBtn = document.getElementById('renderBtn');
                this.resetBtn = document.getElementById('resetBtn');
            }

            initializePresetTemplates() {
                this.templates = {
                    simple_world: `# Einfache Test-Welt
name: "Einfache Welt"
description: "Zum Testen der Presets"
id: "test-simple"

environment:
  ambient_light: 0.6
  sun_intensity: 0.8

terrain:
  preset: "grass_flat"

objects:
  - preset: "tree_simple"
    position: [3, 0, 3]
  
  - preset: "rock_small"
    position: [-3, 0, -3]

personas:
  - preset: "npc_plain"
    name: "Test NPC"
    position: [0, 0, 5]`,

                    forest: `# Wald-Zone mit Presets
name: "Preset Wald"
description: "Wald mit allen Preset-Features"
id: "test-forest"

environment:
  ambient_light: 0.4
  sun_intensity: 0.3

terrain:
  preset: "forest_floor"

objects:
  - preset: "tree_simple"
    position: [5, 0, 5]
    scale: [2, 2.5, 2]
    
  - preset: "mushroom_small"
    position: [2, 0, -3]
    interactive: true
    
  - preset: "stone_circle_thin"
    position: [0, 0, 0]

personas:
  - preset: "npc_guardian"
    name: "Waldw√§chter"
    position: [-3, 0, 8]
    
  - preset: "npc_fairy"
    name: "Waldfee"
    position: [3, 0, -5]`,

                    library: `# Bibliotheks-Zone
name: "Preset Bibliothek"
description: "Bibliothek mit Scholar NPCs"
id: "test-library"

environment:
  ambient_light: 0.8
  sun_intensity: 0.0

terrain:
  preset: "marble_flat"

objects:
  - preset: "bookshelf"
    position: [5, 0, 5]
    
  - preset: "bookshelf"
    position: [-5, 0, 5]
    
  - preset: "crystal"
    position: [0, 0, 0]

personas:
  - preset: "npc_scholar"
    name: "Bibliothekar"
    position: [0, 0, 8]`,

                    single_terrain: `# Nur Terrain Test
name: "Terrain Test"
id: "test-terrain"

environment:
  ambient_light: 0.6

terrain:
  preset: "forest_floor"
  size: [40, 40]`,

                    single_object: `# Nur Objekt Test
name: "Objekt Test"
id: "test-object"

environment:
  ambient_light: 0.6

terrain:
  preset: "grass_flat"
  size: [20, 20]

objects:
  - preset: "tree_simple"
    position: [0, 0, 0]
    scale: [2, 3, 2]`,

                    single_persona: `# Nur NPC Test
name: "NPC Test"
id: "test-npc"

environment:
  ambient_light: 0.6

terrain:
  preset: "grass_flat"
  size: [20, 20]

personas:
  - preset: "npc_plain"
    name: "Test Character"
    position: [0, 0, 3]`
                };
            }

            setupEventListeners() {
                this.loadBtn.addEventListener('click', () => this.loadTemplate());
                this.renderBtn.addEventListener('click', () => this.renderYAML());
                this.resetBtn.addEventListener('click', () => this.resetScene());
                
                // Auto-render bei YAML-√Ñnderungen (mit Debounce und besserer Fehlerbehandlung)
                let timeout;
                this.yamlEditor.addEventListener('input', () => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        // Nur rendern wenn YAML vollst√§ndig aussieht
                        const yamlText = this.yamlEditor.value.trim();
                        console.log('üîÑ Auto-render check:', { 
                            hasText: !!yamlText, 
                            isValid: this.isValidTypingState(yamlText),
                            textLength: yamlText.length 
                        });
                        
                        if (yamlText && this.isValidTypingState(yamlText)) {
                            console.log('‚úÖ Auto-rendering YAML...');
                            this.renderYAML();
                        } else {
                            console.log('‚è≥ Waiting for complete YAML...');
                        }
                    }, 1500); // L√§ngere Wartezeit
                });

                // Kamera-Kontrollen
                this.canvas.addEventListener('mousedown', (e) => this.onMouseDown(e));
                this.canvas.addEventListener('wheel', (e) => this.onWheel(e), { passive: false });
                window.addEventListener('resize', () => this.onWindowResize());
            }

            isValidTypingState(text) {
                // Schnellchecks
                if (!text || !text.trim()) return false;
                const trimmed = text.trim();

                // 1) Offensichtliche Tipp-Zust√§nde (ohne false-positives bei g√ºltigen Bl√∂cken)
                const loosePatterns = [
                    /^\s*-\s*$/m,           // leeres Listen-Item
                    /^\s*preset:\s*$/m,     // preset: ohne Wert
                    /\[\s*\d+\s*,?\s*$/,   // unvollst√§ndiges Array [1,
                ];
                for (const p of loosePatterns) {
                    if (p.test(trimmed)) {
                        console.log('üö´ Typing pattern detected:', p.toString());
                        return false;
                    }
                }

                // 2) Kontext-basierter Check f√ºr Key-Zeilen: "key:" ist nur Tipp, wenn keine sinnvolle Folgezeile folgt
                const lines = trimmed.split('\n');
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    const next = lines[i + 1];

                    const isKeyOnly = /^\s*[\w-]+:\s*$/.test(line);
                    if (isKeyOnly) {
                        // Wenn n√§chste Zeile fehlt oder nur Leerraum ‚Üí noch Tippzustand
                        if (!next || /^\s*$/.test(next)) {
                            console.log('üö´ Key with empty or missing next line:', line);
                            return false;
                        }
                        // Wenn n√§chste Zeile nicht einger√ºckt ist ‚Üí Struktur noch nicht begonnen
                        const isIndentedNext = /^\s+/.test(next);
                        if (!isIndentedNext) {
                            console.log('üö´ Key without indented content yet:', line);
                            return false;
                        }
                    }
                }

                // 3) Robuster Check auf ungeschlossene Strings per Quote-Z√§hlung
                const dqCount = (trimmed.match(/\"/g) || []).length; // count "
                const sqCount = (trimmed.match(/'/g) || []).length;    // count '
                // Wenn ungerade Anzahl, ist irgendein String offen
                if (dqCount % 2 !== 0 || sqCount % 2 !== 0) {
                    console.log('üö´ Unmatched quotes detected (single or double)');
                    return false;
                }

                // 4) YAML Parse-Probe
                try {
                    const parsed = jsyaml.load(trimmed);
                    const isObject = parsed !== null && typeof parsed === 'object';
                    if (!isObject) {
                        console.log('üö´ YAML parsed but not an object');
                        return false;
                    }
                } catch (e) {
                    console.log('‚ùå YAML parse error (still typing?):', e.message);
                    return false;
                }

                // 5) Sonderfall: minimales, aber g√ºltiges Snippet erlauben (z.B. nur terrain + preset)
                // Wenn wir bis hierher kommen, ist es renderbar
                return true;
            }

            loadTemplate() {
                const selectedTemplate = this.presetSelect.value;
                if (selectedTemplate && this.templates[selectedTemplate]) {
                    this.yamlEditor.value = this.templates[selectedTemplate];
                    this.renderYAML();
                }
            }

            async initThreeJS() {
                try {
                    // Scene
                    this.scene = new THREE.Scene();
                    this.scene.background = new THREE.Color(0x87ceeb);

                    // Camera
                    this.camera = new THREE.PerspectiveCamera(75, this.canvas.clientWidth / this.canvas.clientHeight, 0.1, 1000);
                    this.camera.position.set(15, 15, 15);
                    this.camera.lookAt(0, 0, 0);

                    // Renderer
                    this.renderer = new THREE.WebGLRenderer({ canvas: this.canvas, antialias: true });
                    this.renderer.setSize(this.canvas.clientWidth, this.canvas.clientHeight);
                    this.renderer.shadowMap.enabled = true;
                    this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                    if (THREE.sRGBEncoding) {
                        this.renderer.outputEncoding = THREE.sRGBEncoding;
                    }

                    // Lights
                    const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                    this.scene.add(ambientLight);

                    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                    directionalLight.position.set(10, 20, 10);
                    directionalLight.castShadow = true;
                    this.scene.add(directionalLight);

                    this.loadingIndicator.style.display = 'none';
                    this.updateStatus('THREE.js initialisiert - Bereit zum Visualisieren');
                    
                    this.animate();

                } catch (error) {
                    console.error('THREE.js Initialisierung fehlgeschlagen:', error);
                    this.showError('THREE.js konnte nicht geladen werden: ' + error.message);
                }
            }

            async renderYAML() {
                const yamlText = this.yamlEditor.value.trim(); if (!yamlText) { this.updateStatus('Kein YAML-Code vorhanden'); return; }
                try {
                    this.updateStatus('Visualisiere YAML...'); this.resetScene(false);
                    const worldData = jsyaml.load(yamlText);
                    const spec = resolveWorldSpec(worldData);
                    const rng = Math.random;
                    const zoneInfo = buildZoneFromSpec(spec, { rng });

                    // Kamera-Referenz f√ºr Billboarding setzen (wie in index.html Welt)
                    this.scene.userData.__camera = this.camera;

                    this.scene.add(zoneInfo.group);
                    this.currentZone = zoneInfo;
                    const count = (zoneInfo.objects?.length||0) + (zoneInfo.personas?.length||0) + (zoneInfo.portals?.length||0) + 1;
                    this.updateObjectCount(count);
                    this.updateStatus('‚úÖ YAML erfolgreich visualisiert');
                } catch (error) {
                    console.error('YAML Visualisierung Error:', error);
                    if (error.name === 'YAMLException' && error.message.includes('colon is missed')) this.updateStatus('‚ö†Ô∏è YAML wird getippt... (Doppelpunkt fehlt)');
                    else { this.showError('YAML Fehler: ' + error.message); this.updateStatus('‚ùå YAML Visualisierung fehlgeschlagen'); }
                }
            }

            resetScene(updateStatus = true) {
                // Remove current zone
                if (this.currentZone) {
                    this.scene.remove(this.currentZone.group);
                    this.currentZone = null;
                }

                if (updateStatus) {
                    this.updateStatus('Szene zur√ºckgesetzt');
                    this.updateObjectCount(0);
                }
            }

            animate() {
                this.animationId = requestAnimationFrame(() => this.animate());
                
                // Einfache Kamerafahrt f√ºr die Vorschau
                if (this.currentZone) {
                    const time = Date.now() * 0.0005;
                    this.camera.position.x = Math.cos(time) * 20;
                    this.camera.position.z = Math.sin(time) * 20;
                    this.camera.lookAt(0, 0, 0);
                }

                this.renderer.render(this.scene, this.camera);
            }

            // Helper methods
            updateStatus(text) {
                this.statusText.textContent = text;
            }

            updateObjectCount(count) {
                this.objectCount.textContent = `${count} Objekte`;
            }

            showError(message) {
                // Remove existing errors
                const existingError = document.querySelector('.error');
                if (existingError) existingError.remove();

                // Show new error
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = message;
                document.querySelector('.right-panel').appendChild(errorDiv);

                // Auto-remove after 5 seconds
                setTimeout(() => errorDiv.remove(), 5000);
            }

            onMouseDown(event) {
                // Simple camera controls could go here
            }

            onWheel(event) {
                // Zoom control
                event.preventDefault();
                const scale = event.deltaY > 0 ? 1.1 : 0.9;
                this.camera.position.multiplyScalar(scale);
            }

            onWindowResize() {
                const width = this.canvas.clientWidth;
                const height = this.canvas.clientHeight;
                
                this.camera.aspect = width / height;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(width, height);
            }
        }

        // Initialize when page loads
        window.addEventListener('load', () => { new PresetEditor(); });
    </script>
</body>
</html>
